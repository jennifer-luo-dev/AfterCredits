{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/jennifer/personalprojects/AfterCredits/aftercredits/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\ndeclare global {\n  // allow global prisma across hot reloads in dev\n  // eslint-disable-next-line no-var\n  var __prisma: PrismaClient | undefined;\n}\n\nexport const prisma = global.__prisma ?? new PrismaClient();\nif (process.env.NODE_ENV !== \"production\") global.__prisma = prisma;\n"],"names":[],"mappings":";;;;AAAA;;AAQO,MAAM,SAAS,OAAO,QAAQ,IAAI,IAAI,6IAAY;AACzD,wCAA2C,OAAO,QAAQ,GAAG"}},
    {"offset": {"line": 100, "column": 0}, "map": {"version":3,"sources":["file:///Users/jennifer/personalprojects/AfterCredits/aftercredits/src/app/api/memory/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { prisma } from \"../../../lib/prisma\";\nimport { createClient as createSupabaseClient } from \"@supabase/supabase-js\";\n\nconst SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst SUPABASE_SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;\nconst supabaseAdmin =\n  SUPABASE_URL && SUPABASE_SERVICE_ROLE_KEY\n    ? createSupabaseClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)\n    : null;\n\n// GET /api/memory - list memories\nexport async function GET(request: Request) {\n  const url = new URL(request.url);\n  const userId = url.searchParams.get(\"userId\");\n  // Build options dynamically and avoid strict typing issues\n  const findOptions: any = { orderBy: { createdAt: \"desc\" } };\n  if (userId) findOptions.where = { userId };\n  const memories = await prisma.memory.findMany(findOptions);\n\n  // If we have a SUPABASE_SERVICE_ROLE_KEY, generate short-lived signed urls for private images\n  if (supabaseAdmin) {\n    const withUrls = await Promise.all(\n      memories.map(async (m: any) => {\n        if (!m.imagePath) return m;\n        try {\n          // Check if imagePath is a folder by trying to list its contents\n          const { data: files, error: listError } = await supabaseAdmin.storage\n            .from(\"memories\")\n            .list(m.imagePath);\n\n          if (!listError && files && files.length > 0) {\n            // imagePath is a folder - get the first file\n            const firstFile = files.find(\n              (f: any) => f.name !== \".emptyFolderPlaceholder\"\n            );\n            if (firstFile) {\n              const filePath = `${m.imagePath}/${firstFile.name}`;\n              const { data, error } = await supabaseAdmin.storage\n                .from(\"memories\")\n                .createSignedUrl(filePath, 60 * 15);\n              if (!error && data?.signedUrl) {\n                return { ...m, imageSrc: data.signedUrl };\n              }\n            }\n          } else if (!listError) {\n            // imagePath is likely a single file, not a folder - try to create signed URL directly\n            const { data, error } = await supabaseAdmin.storage\n              .from(\"memories\")\n              .createSignedUrl(m.imagePath, 60 * 15);\n            if (!error && data?.signedUrl) {\n              return { ...m, imageSrc: data.signedUrl };\n            }\n          }\n\n          console.warn(\"Could not create signed URL for\", m.imagePath);\n          return m;\n        } catch (err) {\n          console.warn(\"Failed to create signed URL\", err);\n          return m;\n        }\n      })\n    );\n    return NextResponse.json(withUrls);\n  }\n\n  // No service role key available. Attempt a best-effort public URL fallback\n  // (this will only work if your \"memories\" bucket is public). For private\n  // buckets you should set SUPABASE_SERVICE_ROLE_KEY in your environment so\n  // the server can generate signed URLs.\n  const withFallback = memories.map((m: any) => ({\n    ...m,\n    imageSrc:\n      m.imageUrl ??\n      (SUPABASE_URL && m.imagePath\n        ? `${SUPABASE_URL}/storage/v1/object/public/memories/${encodeURIComponent(\n            m.imagePath\n          )}`\n        : null),\n  }));\n\n  return NextResponse.json(withFallback);\n}\n\n// POST /api/memory - create a memory\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json();\n    const { title, date, location, description, imagePath, imageUrl, userId } =\n      body;\n\n    const data: any = {\n      title,\n      location: location ?? null,\n      description: description ?? null,\n      imageUrl: imageUrl ?? null,\n      imagePath: imagePath ?? null,\n      userId: userId ?? null,\n    };\n\n    console.log(\"REQ BODY:\", body);\n    // Memory model requires a DateTime `date`. Default to now if missing.\n    data.date = date ? new Date(date) : new Date();\n\n    const memory = await prisma.memory.create({ data });\n\n    return NextResponse.json(memory, { status: 201 });\n  } catch (err: any) {\n    console.error(\"Failed to create memory:\", err);\n    // Return the actual error message so the client can show helpful info\n    const message = err?.message ?? \"Failed to create memory\";\n    return NextResponse.json({ error: message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}